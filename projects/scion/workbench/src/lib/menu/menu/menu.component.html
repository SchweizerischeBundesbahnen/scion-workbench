@let subMenuItem = this.subMenuItem();
@if (subMenuItem.type === 'group' && (subMenuItem.label?.length || subMenuItem.collapsible)) {
  @let group = subMenuItem;
  @if (group.collapsible) {
    <button class="group-header" (click)="onGroupToggle()" (mouseenter)="onMenuItemMouseEnter(group)">
      <span class="icon material-symbols-rounded" translate="no">{{isGroupVisible() ? 'keyboard_arrow_down' : 'chevron_right'}}</span>
      <span class="label">{{subMenuItem.label}}</span>
    </button>
  } @else {
    <span class="group-label">{{subMenuItem.label}}</span>
  }
}

@if (isGroupVisible()) {
  @if (subMenuItem.filter) {
    <div class="filter">
      <span class="icon material-symbols-rounded filter" translate="no">search</span>
      <wb-menu-filter (textChange)="onFilterChange($event)" [placeholder]="(typeof subMenuItem.filter === 'object' && subMenuItem.filter.placeholder) || 'Type to filter'"/>
    </div>

    <hr>
  }

  @for (menuItem of menuItems(); track menuItem) {
    @switch (menuItem.type) {
      @case ('menu-item') {
        <button class="menu-item"
                (mouseenter)="onMenuItemMouseEnter(menuItem)"
                [attr.disabled]="this.disabled() || (menuItem.disabled?.() ?? false) || null"
                (click)="menuItem.onSelect()">
          @if (hasGutterColumn()) {
            @if (!menuItem.checked) {
              <span class="icon material-symbols-rounded" translate="no">{{menuItem.icon}}</span>
            } @else {
              <span class="icon material-symbols-rounded checkmark" translate="no">{{menuItem.checked() ? 'check' : ''}}</span>
            }
          }

          <span class="label">{{menuItem.label}}</span>
          @if (menuItem.accelerator?.length) {
            <span class="accelerator">{{menuItem.accelerator | wbJoin:'+'}}</span>
          }
        </button>
      }
      @case ('sub-menu-item') {
        <button [attr.popovertarget]="popoverId"
                [attr.popovertargetaction]="'show'"
                [style.anchor-name]="activeSubMenuItem() === menuItem ? `--${popoverId}` : null"
                [attr.disabled]="this.disabled() || (menuItem.disabled?.() ?? false) || null"
                class="menu-item"
                (mouseenter)="onMenuItemMouseEnter(menuItem)">
          @if (hasGutterColumn()) {
            <span class="icon material-symbols-rounded" translate="no">{{menuItem.icon}}</span>
          }
          <span class="label">{{menuItem.label}}</span>
          <span class="icon material-symbols-rounded sub-menu-chevron" translate="no">arrow_right</span>
        </button>
      }
      @case ('group') {
        <wb-group [group]="menuItem" [hasGutterColumn]="hasGutterColumn()" [disabled]="this.disabled() || (menuItem.disabled?.() ?? false)"/>
      }
    }
  } @empty {
    @if (subMenuItem.filter) {
      <div class="empty">{{(typeof subMenuItem.filter === 'object' && subMenuItem.filter.notFoundText) || 'No items found.'}}</div>
    }
  }

  @if (activeSubMenuItem()) {
    <wb-menu [subMenuItem]="activeSubMenuItem()!"
             [attr.id]="popoverId"
             [style.position-anchor]="`--${popoverId}`"
             [disabled]="this.disabled() || (activeSubMenuItem()!.disabled?.() ?? false)"
             (toggle)="onTogglePopover($event)"
             popover #popover/>
  }
}
